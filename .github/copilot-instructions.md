# Copilot Instructions for logue-sdk-ripplerx

- Purpose: port the RipplerX physical-modelling synth to drumlogue; see context in [platform/drumlogue/ripplerx/README.md](platform/drumlogue/ripplerx/README.md).
- Architecture: the unit entrypoints live in [platform/drumlogue/ripplerx/unit.cc](platform/drumlogue/ripplerx/unit.cc) and forward all callbacks to a single `RipplerX` instance defined in [platform/drumlogue/ripplerx/ripplerx.h](platform/drumlogue/ripplerx/ripplerx.h).
- Engine layout: `RipplerX` owns 8 voices (see `c_numVoices` in [platform/drumlogue/ripplerx/constants.h](platform/drumlogue/ripplerx/constants.h)) built from `Voice`, `Resonator`, `Mallet`, `Noise`, `Waveguide`, and `Models` classes under [platform/drumlogue/ripplerx/](platform/drumlogue/ripplerx/); audio is rendered per-call with NEON-friendly loops in `Render`.
- DSP constraints: samplerate is fixed at 48 kHz and stereo output is enforced; `Init` rejects other geometries early in [platform/drumlogue/ripplerx/ripplerx.h](platform/drumlogue/ripplerx/ripplerx.h). ARMv7-A, hard-float, NEON are assumed; doubles are avoided to stay on ARMv7.
- Parameters: the user-facing parameter map is defined in [platform/drumlogue/ripplerx/header.c](platform/drumlogue/ripplerx/header.c) (24 slots spread across 6 pages). Program/preset names, parameter indices, and enumerated string tables (models, partial counts, noise filter modes, sample banks) live in [platform/drumlogue/ripplerx/constants.h](platform/drumlogue/ripplerx/constants.h).
- Presets: 28 internal programs are pre-baked as float tables in `programs` inside [platform/drumlogue/ripplerx/constants.h](platform/drumlogue/ripplerx/constants.h); `LoadPreset` pulls from there instead of XML. Respect these when adding programs to keep header indices aligned.
- Sample access: runtime function pointers (`get_num_sample_banks`, `get_num_samples_for_bank`, `get_sample`) are cached during `Init`; ensure any new sample handling uses these rather than storing raw pointers long-term.
- MIDI path: note/gate/pitchbend/aftertouch/channel pressure handlers simply pass through to `RipplerX`; prefer adding logic in the synth rather than the unit stubs in [platform/drumlogue/ripplerx/unit.cc](platform/drumlogue/ripplerx/unit.cc).
- Polyphony and stealing: `Voice` tracks `m_framesSinceNoteOn` for basic stealing; keep updates cheap and avoid allocations in the render path.
- Future comment at the top of [platform/drumlogue/ripplerx/ripplerx.h](platform/drumlogue/ripplerx/ripplerx.h) describes a multi-timbral plan that is **not** implemented—treat as design notes, not live requirements.
- Build (recommended): use Docker scripts under [docker/](docker/) (`./run_interactive.sh` then `build drumlogue/ripplerx`) to get a consistent cross toolchain; final artifacts land in `platform/drumlogue/ripplerx/build/*.drmlgunit`.
- Build (local make inside container): `env drumlogue` then `make` inside [platform/drumlogue/ripplerx](platform/drumlogue/ripplerx). `config.mk` sets `PROJECT:=resonator`; outputs are named `resonator.*` unless overridden.
- Cleaning: `build -c drumlogue/ripplerx` or `make clean` (container) removes `build/`, `.dep/`, and installed unit files.
- Coding style: C++14 with heavy NEON intrinsics; `-ffast-math`, `-funsafe-math-optimizations`, and aggressive inlining are enabled in [platform/drumlogue/ripplerx/Makefile](platform/drumlogue/ripplerx/Makefile). Keep vectorizable, branch-light inner loops and avoid heap usage in audio callbacks.
- Parameter UI: display strings are limited to 12–32 ASCII chars; respect constraints noted in [platform/drumlogue/README.md](platform/drumlogue/README.md) and [platform/drumlogue/ripplerx/header.c](platform/drumlogue/ripplerx/header.c) when adding parameters.
- Gain staging: output is summed into stereo and passed through `Comb` and `Limiter` (see [platform/drumlogue/ripplerx/ripplerx.h](platform/drumlogue/ripplerx/ripplerx.h)); keep per-voice output normalized and prefer adjusting `gain` parameter rather than hardcoding scalars.
- Testing on hardware: units load via USB mass storage into `Units/Synths/` as `.drmlgunit`; loading order can be forced via filename prefixes per [platform/drumlogue/README.md](platform/drumlogue/README.md).
- When extending parameters or presets, update `header.c`, the enums/arrays in `constants.h`, and any default loading logic together to avoid index drift.
- Keep edits ASCII; existing sources assume 7-bit ASCII for names and preset strings.
